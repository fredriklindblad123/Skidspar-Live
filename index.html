<!DOCTYPE html>
<html lang="sv">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skidsp√•r V√§st AI Agent</title>
    <link rel="stylesheet" href="style.css">

    <script src="chart.js"></script>
    <link rel="icon" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
</head>

<body>
    <div class="container">
        <header>
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                <img src="logo.png" alt="Logo" style="height: 60px; width: auto; border-radius: 50%;">
                <h1>Skidsp√•r V√§st</h1>
            </div>
            <div class="subtitle">AI-driven status f√∂r l√§ngdskidsp√•r i V√§stra G√∂taland</div>
        </header>

        <!-- Toolbar -->
        <div class="toolbar"
            style="margin-bottom: 20px; display: flex; gap: 12px; flex-wrap: wrap; align-items: center; justify-content: center;">

            <!-- Filters -->
            <span
                style="font-size:0.75rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-secondary); margin-right:4px;">Filter:</span>


            <button class="filter-btn" data-tag="konstsn√∂" onclick="toggleFilter('konstsn√∂')"
                style="display:flex; align-items:center; gap:6px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path
                        d="M2.05 2.05h2v2h-2zM2.05 20h2v2h-2zM20 20h2v2h-2zM20 2.05h2v2h-2zM12 2.05v2M12 20v2M2.05 12h2M20 12h2M5.64 5.64l1.41 1.41M16.95 16.95l1.41 1.41M5.64 18.36l1.41-1.41M16.95 7.05l1.41-1.41M12 7.05v9.9M7.05 12h9.9">
                    </path>
                </svg>
                Konstsn√∂
            </button>
            <button class="filter-btn" data-tag="elljus" onclick="toggleFilter('elljus')"
                style="display:flex; align-items:center; gap:6px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
                Elljus
            </button>
            <button class="filter-btn" data-tag="wc" onclick="toggleFilter('wc')"
                style="display:flex; align-items:center; gap:6px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 21h6"></path>
                    <path d="M12 21v-4"></path>
                    <path d="M7 3h10a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"></path>
                </svg>
                WC
            </button>
            <button class="filter-btn" data-tag="dusch" onclick="toggleFilter('dusch')"
                style="display:flex; align-items:center; gap:6px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14.4 7.2L12 12l2.4 4.8"></path>
                    <path d="M6 12h12"></path>
                    <path d="M6 5v14"></path>
                </svg>
                Dusch
            </button>
            <button class="filter-btn" data-tag="omkl√§dningsrum" onclick="toggleFilter('omkl√§dningsrum')"
                style="display:flex; align-items:center; gap:6px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path>
                    <line x1="16" y1="8" x2="2" y2="22"></line>
                    <line x1="17.5" y1="15" x2="9" y2="15"></line>
                </svg>
                Omkl.
            </button>
        </div>

        <!-- Overview Map (Hidden Default) -->


        <div class="split-layout">
            <div class="grid" id="dashboard-summary" style="margin-bottom: 40px;">
                <!-- Summary cards will appear here -->
            </div>

            <div class="grid" id="track-grid">
                <!-- Loading State or Details -->
                <div style="text-align:center; color: var(--text-secondary); padding: 40px; font-style: italic;">
                    V√§lj en anl√§ggning ovan f√∂r att se detaljer
                </div>
            </div>
        </div>

        <footer>
            <div>Uppdateras automatiskt var 4:e timma via GitHub Actions.</div>
            <div class="refresh-time" id="last-updated">Senast uppdaterad: Laddar...</div>
        </footer>
    </div>

    <script>
        function escapeHtml(s) {
            if (!s) return '';
            return s
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\r/g, '');
        }

        function escapeHtml(s) {
            if (!s) return '';
            return s
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\r/g, '');
        }

        // --- NEW FEATURES STATE ---
        let map = null;
        let mapMarkers = [];
        let activeFilters = new Set();
        let allTracksData = [];
        let favorites = JSON.parse(localStorage.getItem('skiFavorites') || '[]');
        let isMapVisible = false;

        function toggleFilter(tag) {
            const btn = document.querySelector(`button[data-tag="${tag}"]`);
            if (activeFilters.has(tag)) {
                activeFilters.delete(tag);
                btn.classList.remove('active');
            } else {
                activeFilters.add(tag);
                btn.classList.add('active');
            }
            renderDashboard(); // Re-render list
            // Also need to re-render detail view if the currently shown track is filtered out?
            // Or just update the map in duplicate detail view?
            // User requested: "D√§r vill jag se alla anl√§ggningars position (men bara dom filtrerade...)"

            // If we have a currently rendered track, maybe update its map section? 
            // Since we can't easily reach into the specific DOM element without re-rendering,
            // we will rely on user clicking. BUT wait, if I filter, the detail view map should update immediately.
            // Let's defer that optimization or just re-render dashboard which is enough.
            // However, the requested feature is about the detail view map showing filtered dots.

            // For now, just renderDashboard.

            // Re-render detail view if active? 
            // Actually, we need to refresh the "all dots" on the detail map.
            // Since we don't track "currentDetailTrack" globally easily, let's keep it simple.
        }

        function toggleFilter(tag) {
            const btn = document.querySelector(`button[data-tag="${tag}"]`);
            if (activeFilters.has(tag)) {
                activeFilters.delete(tag);
                btn.classList.remove('active');
            } else {
                activeFilters.add(tag);
                btn.classList.add('active');
            }
            renderDashboard(); // Re-render list
        }

        function applyFilters(data) {
            if (activeFilters.size === 0) return data;
            return data.filter(track => {
                const trackTags = (track.tags || []).map(t => t.toLowerCase());
                // Check if track has ALL active filters (AND logic)
                for (let filter of activeFilters) {
                    // special check for "dog" vs "hundtill√•tet" if needed, but I used "dog" in HTML and "hundtill√•tet" in generic plan?
                    // actually scraper uses Swedish tags. I should align them.
                    // "dog" button -> check "hundtill√•tet" ?
                    // Let's assume tags match or I map them.
                    // scraper tags: "konstsn√∂", "elljus", "natursn√∂"
                    // HTML buttons: "konstsn√∂", "elljus", "dog".
                    // I need to fix the HTML button for dog to use a tag that exists or match logic.
                    // Scraper doesn't have "hundtill√•tet" yet? I planned to add it but maybe skipped?
                    // I see "konstsn√∂", "elljus" in scraper. I did NOT see "hundtill√•tet" in plain text in my `replace_file` call?
                    // I should check scraper again or just omit dog for now.
                    if (filter === 'dog') { // Temporary mapping
                        if (!trackTags.includes('hundtill√•tet')) return false;
                    } else {
                        if (!trackTags.includes(filter)) return false;
                    }
                }
                return true;
            });
        }

        function toggleFavorite(e, name) {
            e.stopPropagation();
            if (favorites.includes(name)) {
                favorites = favorites.filter(n => n !== name);
            } else {
                favorites.push(name);
            }
            localStorage.setItem('skiFavorites', JSON.stringify(favorites));
            renderDashboard();
        }

        function getWaxRecommendation(tempStr) {
            if (!tempStr) return null;
            const temp = parseFloat(tempStr.replace('¬∞C', '').replace(',', '.'));
            if (isNaN(temp)) return null;

            if (temp > 1) return { text: "Klister (eller ruggat)", color: "#ef4444" }; // Red
            if (temp >= 0) return { text: "Violett/R√∂d (VR55/60)", color: "#a855f7" }; // Purple
            if (temp >= -3) return { text: "Bl√• (VR45/VR40)", color: "#3b82f6" }; // Blue
            if (temp >= -10) return { text: "Gr√∂n/Bl√• (V40/V30)", color: "#22c55e" }; // Green
            return { text: "Gr√∂n (Polar)", color: "#15803d" };
        }

        function renderDashboard() {
            const summaryGrid = document.getElementById('dashboard-summary');
            summaryGrid.innerHTML = '';

            let filtered = applyFilters(allTracksData);

            // Sort: Favorites first, then Status
            filtered.sort((a, b) => {
                const isFavA = favorites.includes(a.name);
                const isFavB = favorites.includes(b.name);
                if (isFavA && !isFavB) return -1;
                if (!isFavA && isFavB) return 1;

                const getRank = (status, comments) => {
                    // Logic: Rank 1 (Open), Rank 2 (Probable), Rank 3 (Closed), Rank 4 (Unknown)
                    // If Favorite, maybe boost it? Handled above.
                    if (!status) return 4;
                    const s = status.toLowerCase();
                    if (s.includes('√∂ppet') && !s.includes('troligen')) return 1;
                    if (s.includes('troligen')) return 2;
                    if (s.includes('st√§ngt')) return 3;
                    return 4;
                };
                return getRank(a.status) - getRank(b.status);
            });

            if (filtered.length === 0) {
                summaryGrid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px; color:var(--text-secondary);">Inga anl√§ggningar matchar filtret.</div>';
                return;
            }

            filtered.forEach(track => {
                let statusClass = 'status-unknown';
                let s = track.status ? track.status.toLowerCase() : '';
                if (s.includes('troligen')) statusClass = 'status-probable';
                else if (s.includes('√∂ppet')) statusClass = 'status-open';
                else if (s.includes('st√§ngt')) statusClass = 'status-closed';

                const isFav = favorites.includes(track.name);
                const starColor = isFav ? '#fbbf24' : 'rgba(255,255,255,0.2)'; // amber-400 vs dimmed

                const summaryCard = document.createElement('div');
                summaryCard.className = 'card summary-card';
                summaryCard.onclick = () => renderDetail(track, summaryCard, true);
                summaryCard.style.position = 'relative';

                summaryCard.innerHTML = `
                   <div style="position: absolute; top: 12px; right: 12px; display:flex; align-items:center; gap:8px;">
                       <div onclick="toggleFavorite(event, '${track.name}')" title="${isFav ? 'Ta bort favorit' : 'L√§gg till som favorit'}" style="cursor:pointer; font-size:1.4rem; line-height:1; color:${starColor}; transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'">
                           ‚òÖ
                       </div>
                       <div class="status-badge ${statusClass}">
                            <div class="status-dot"></div>
                            ${track.status || ''}
                       </div>
                   </div>
                   <div style="font-size:0.75rem; color:var(--text-secondary); text-transform:uppercase; margin-bottom:4px; padding-right: 90px;">${track.municipality || ''}</div>
                   <div class="summary-row" style="align-items:center;">
                       <div class="summary-name" style="font-weight:700; font-size:1.1rem; padding-right: 10px;">${track.name || ''}</div>
                   </div>
                `;
                summaryGrid.appendChild(summaryCard);
            });
        }

        async function loadData() {
            try {
                const response = await fetch('data.json?t=' + new Date().getTime());
                const data = await response.json();
                allTracksData = data;

                const grid = document.getElementById('track-grid');

                if (data.length > 0) {
                    document.getElementById('last-updated').textContent = `Senast uppdaterad: ${data[0].last_update}`;

                    renderDashboard(); // Initial render and sort

                    // Default selection: The top item from the *sorted* list used in renderDashboard?
                    // But renderDashboard applies filters and sorts locally.
                    // We can reuse the same sort logic to find the "default" track to show details for.

                    // Re-sort data locally just to find the top one for Detail View
                    const sorted = [...data].sort((a, b) => {
                        const getRank = (status) => {
                            if (!status) return 4;
                            const s = status.toLowerCase();
                            if (s.includes('√∂ppet') && !s.includes('troligen')) return 1;
                            if (s.includes('troligen')) return 2;
                            if (s.includes('st√§ngt')) return 3;
                            return 4;
                        };
                        return getRank(a.status) - getRank(b.status);
                    });

                    // Logic to find "Ulricehamn" or first
                    let defaultTrack = sorted.find(t => t.name.includes('Lassalyckans Skidstadion'));
                    if (!defaultTrack && sorted.length > 0) defaultTrack = sorted[0];

                    if (defaultTrack && window.innerWidth >= 1024) {
                        // Workaround: Call renderDetail(defaultTrack, null, false)
                        renderDetail(defaultTrack, null, false);
                    }
                } else {
                    document.getElementById('last-updated').textContent = 'Kunde inte ladda data';
                }
            } catch (err) {
                console.error('Error loading data:', err);
                document.getElementById('last-updated').textContent = 'Fel vid laddning av data';
            }
        }



        let currentChart = null;

        function renderDetail(track, activeCardElement, shouldScroll = true) {
            // Safely destroy old chart before removing canvas from DOM
            if (currentChart) {
                try {
                    currentChart.destroy();
                } catch (e) {
                    console.log('Chart destroy error:', e);
                }
                currentChart = null;
            }

            const grid = document.getElementById('track-grid');
            grid.innerHTML = ''; // Clear previous

            // Highlight active summary card
            document.querySelectorAll('.summary-card').forEach(el => el.classList.remove('selected'));
            if (activeCardElement) activeCardElement.classList.add('selected');

            let statusClass = 'status-unknown';
            let statusText = track.status || '';
            if (track.status && track.status.toLowerCase().includes('troligen')) statusClass = 'status-probable';
            else if (track.status && track.status.toLowerCase().includes('√∂ppet')) statusClass = 'status-open';
            else if (track.status && track.status.toLowerCase().includes('st√§ngt')) statusClass = 'status-closed';

            const wax = (!statusClass.includes('closed')) ? getWaxRecommendation(track.temperature) : null;

            const card = document.createElement('div');
            card.className = 'card detail-card';
            card.innerHTML = `
                <div class="card-header">
                    <div>
                        <div class="status-badge ${statusClass}" style="margin-bottom:8px; display:inline-flex;">
                            <div class="status-dot"></div>
                            ${statusText}
                        </div>
                        <h2 style="margin:0; font-size:1.8rem; line-height:1.2;">${track.name === 'Skidome G√∂teborg (skidtunnel)' ? 'Skidome' : track.name}</h2>
                        <div style="color:var(--text-secondary); margin-top:4px;">${track.municipality}</div>

                         <!-- Mobile Actions (Vertical under name) -->
                        <div class="contact-actions" style="margin-top:12px; display:flex; flex-direction:column; gap:8px;">
                            ${track.official_url ? `
                            <a href="${track.official_url}" target="_blank" rel="noopener noreferrer" style="color:var(--text-primary); text-decoration:none; display:flex; align-items:center; gap:8px; font-size:0.9em;">
                                <div style="display:flex; align-items:center; justify-content:center; width:24px; height:24px; background:rgba(255,255,255,0.1); border-radius:50%;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                                </div>
                                Officiell hemsida ‚Üó
                            </a>` : ''}
                            ${track.skidspar_url ? `
                            <a href="${track.skidspar_url}" target="_blank" rel="noopener noreferrer" style="color:var(--text-primary); text-decoration:none; display:flex; align-items:center; gap:8px; font-size:0.9em;">
                                <div style="display:flex; align-items:center; justify-content:center; width:24px; height:24px; background:rgba(255,255,255,0.1); border-radius:50%;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22l-5-5L6 21"></path><path d="M18 2l-6 6L6 2"></path><path d="M10 12l2-2-1-1-6 6"></path><path d="M22 19L12 9l-.5.5"></path></svg>
                                </div>
                                Skidsp√•r.se ‚Üó
                            </a>` : ''}
                            <span style="display:flex; align-items:center; gap:8px; color:var(--text-secondary); font-size:0.9em;">
                                <div style="display:flex; align-items:center; justify-content:center; width:24px; height:24px; background:rgba(255,255,255,0.1); border-radius:50%;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                                </div>
                                ${track.phone}
                            </span>
                        </div>

                        <!-- Tags -->
                         <div class="tags-container">
                            ${(track.tags || []).map(tag => `
                                <span class="tag-badge">
                                    ${tag === 'dog' ? 'üê∂ Hund' : tag}
                                </span>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Map Container -->
                    <div class="detail-map-container">
                         <img src="vg_map.png" style="width: 100%; height: 100%; object-fit: contain; opacity: 1; mix-blend-mode: lighten;" alt="Karta">
                         <div id="map-dots-container"></div>
                    </div>
                </div>

                <div class="metrics">
                    <div class="metric">
                        <span class="metric-label">Temperatur</span>
                        <span class="metric-value temp-value">${track.temperature || '-'}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">V√§der</span>
                        <span class="metric-value">${track.weather || '-'}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Natursn√∂</span>
                        <span class="metric-value">${track.snow_depth || '-'}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">√ñppna sp√•r</span>
                        <span class="metric-value">${track.total_track_length_km > 0 ? track.total_track_length_km + ' km' : '&nbsp;'}</span>
                    </div>
                    ${wax ? `
                    <div class="metric">
                        <span class="metric-label">Vallatips</span>
                         <span class="metric-value" style="color:${wax.color}; font-size:0.9em;">${wax.text}</span>
                    </div>
                    ` : `
                    <div class="metric">
                        <span class="metric-label">Vallatips</span>
                         <span class="metric-value" style="color:var(--text-secondary); font-size:0.9em;">-</span>
                    </div>
                    `}
                </div>
                <div class="ai-section">
                    <div class="ai-header">
                        <span>‚ú¶ Senaste uppdateringar</span>
                    </div>
                    <div class="ai-content"></div>
                </div>

                ${track.forecast ? `
                <div class="forecast-section" style="margin-top:20px; padding:0 20px;">
                    <div style="font-size:0.9em; margin-bottom:10px; color:var(--text-secondary);">7-dygnsprognos (Max/Min)</div>
                    <div style="position: relative; height:200px; width:100%">
                        <canvas id="forecastChart"></canvas>
                    </div>
                </div>
                ` : ''
                }
                        `;

            grid.appendChild(card);

            if (shouldScroll && window.innerWidth < 1024) {
                card.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            if (track.forecast) {
                renderForecastChart(track.forecast);
            }

            // Render Map Dots
            const dotsContainer = document.getElementById('map-dots-container');
            if (dotsContainer) {
                const MAX_LAT = 59.4;
                const MIN_LAT = 57.1;
                const MAX_LON = 14.8;
                const MIN_LON = 11.0;

                // Get filtered tracks
                const visibleTracks = applyFilters(allTracksData);

                visibleTracks.forEach(t => {
                    if (t.lat && t.lon) {
                        const topPct = ((MAX_LAT - t.lat) / (MAX_LAT - MIN_LAT)) * 100;
                        const leftPct = ((t.lon - MIN_LON) / (MAX_LON - MIN_LON)) * 100;

                        let dotColor = '#ef4444'; // Red
                        // Check for specific "Troligen √∂ppet" first or prioritize yellow if status has "troligen"
                        if (t.status && t.status.toLowerCase().includes('troligen')) dotColor = '#eab308'; // Yellow
                        else if (t.status && t.status.toLowerCase().includes('√∂ppet')) dotColor = '#22c55e'; // Green

                        const isCurrent = (t.name === track.name);
                        // Sizes increased by ~50%
                        const size = isCurrent ? 18 : 10;
                        const zIndex = isCurrent ? 20 : 10;
                        const border = isCurrent ? '2px solid white' : '1px solid rgba(255,255,255,0.6)';

                        const dotEl = document.createElement('div');
                        dotEl.style.position = 'absolute';
                        dotEl.style.top = `${topPct}%`;
                        dotEl.style.left = `${leftPct}%`;
                        dotEl.style.width = `${size}px`;
                        dotEl.style.height = `${size}px`;
                        dotEl.style.backgroundColor = dotColor;
                        dotEl.style.borderRadius = '50%';
                        dotEl.style.transform = 'translate(-50%, -50%)';
                        dotEl.style.border = border;
                        dotEl.style.zIndex = zIndex;
                        // Add glow to current item for better visibility
                        dotEl.style.boxShadow = isCurrent ? '0 0 12px rgba(255,255,255,0.5)' : 'none';

                        // Optional: Click to switch to that track?
                        // dotEl.onclick = () => renderDetail(t, null, true); // Might be nice?

                        dotsContainer.appendChild(dotEl);
                    }
                });
            }

            const aiContent = card.querySelector('.ai-content');
            if (track.ai_comments && Array.isArray(track.ai_comments) && track.ai_comments.length > 0) {
                // Take max 2 comments just in case
                const limitedComments = track.ai_comments.slice(0, 2);
                aiContent.innerHTML = limitedComments.map(c => {
                    const body = (c.text || c.comment || '').replace(/\r/g, '').split('\n').map(escapeHtml).join('<br>');
                    const days = c.days_ago;
                    let timeText = '';
                    if (days === 0) timeText = 'Idag';
                    else if (days === 1) timeText = 'Ig√•r';
                    else timeText = `${days} dagar sedan`;

                    const meta = escapeHtml(timeText);
                    return `<div class="comment"><div class="meta">${meta}</div><div class="body">${body}</div></div>`;
                }).join('');
            } else {
                if (track.ai_summary) {
                    const summary = String(track.ai_summary).replace(/\\n/g, '\n');
                    aiContent.innerHTML = escapeHtml(summary).replace(/\n/g, '<br>');
                } else {
                    aiContent.textContent = '';
                }
            }
        }



        function renderForecastChart(forecast) {
            const ctx = document.getElementById('forecastChart');
            if (!ctx) return;

            // Dates to short day names
            const dateLabels = forecast.dates.map(dStr => {
                const date = new Date(dStr);
                return date.toLocaleDateString('sv-SE', { weekday: 'short' });
            });

            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dateLabels,
                    datasets: [
                        {
                            label: 'Max',
                            data: forecast.max_temp,
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 3
                        },
                        {
                            label: 'Min',
                            data: forecast.min_temp,
                            borderColor: '#4dabf7',
                            backgroundColor: 'rgba(77, 171, 247, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#ccc', font: { size: 11 } }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': ' + context.parsed.y + '¬∞C';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#888', callback: function (value) { return value + '¬∞' } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#888' }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        loadData();
    </script>
</body>

</html>